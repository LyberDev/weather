name: Build release (AppImage + Windows .exe x64/x86)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build-windows:
    name: Build Windows executables
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: ${{ matrix.arch }}

      - name: Install dependencies and PyInstaller
        shell: bash
        run: |
          python -m pip install --upgrade pip
          # Prefer existing requirements.txt; otherwise try to generate it
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pipreqs || true
            pipreqs --force . || true
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          fi
          pip install pyinstaller

      - name: Build with PyInstaller
        shell: bash
        env:
          INPUT_PATH: weather.py
        run: |
          pyinstaller --noconfirm --onefile --name weather "$INPUT_PATH"
          # Для 32-bit переименуем артефакт
          if [ "${{ matrix.arch }}" = "x86" ]; then
            if [ -f dist/weather.exe ]; then mv dist/weather.exe dist/weather-win32.exe; fi
          fi

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: weather-windows-${{ matrix.arch }}
          path: |
            dist/weather.exe
            dist/weather-win32.exe

  build-linux-appimage:
    name: Build AppImage (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies and PyInstaller
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pipreqs || true
            pipreqs --force . || true
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          fi
          pip install pyinstaller
        shell: bash

      - name: Build binary with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --name weather weather.py
        shell: bash

      - name: Download linuxdeploy and appimagetool
        run: |
          wget -q -O linuxdeploy.AppImage https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy.AppImage || true
          wget -q -O linuxdeploy-plugin-python.AppImage https://github.com/linuxdeploy/linuxdeploy-plugin-python/releases/download/continuous/linuxdeploy-plugin-python-x86_64.AppImage
          chmod +x linuxdeploy-plugin-python.AppImage || true
          wget -q -O appimagetool.AppImage https://github.com/AppImage/AppImageKit/releases/latest/download/appimagetool-x86_64.AppImage
          chmod +x appimagetool.AppImage || true
        shell: bash

      - name: Create AppDir and bundle AppImage
        run: |
          set -e
          mkdir -p AppDir/usr/bin
          cp -v dist/weather AppDir/usr/bin/weather || true

          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/weather.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Weather
          Exec=weather
          Icon=weather
          EOF

          ./linuxdeploy.AppImage --appdir AppDir --output appimage || true

          if ls *.AppImage 1> /dev/null 2>&1; then
            for f in *.AppImage; do mv "$f" weather.AppImage || true; done
          fi
        shell: bash

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: weather-linux-appimage
          path: weather.AppImage

# Примечания:
# - Скрипт пытается установить зависимости из requirements.txt. Если его нет — пробует сгенерировать через pipreqs.
# - PyInstaller используется для сборки одного исполняемого файла. Для AppImage используется linuxdeploy + appimagetool; в некоторых случаях может потребоваться доработка (иконка, дополнительные libs).
# - Артефакты будут доступны в Actions -> выбранный run -> Artifacts.
