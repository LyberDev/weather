name: Build release (Linux tar.gz + Windows .exe x64/x86)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build-windows:
    name: Build Windows executables
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: ${{ matrix.arch }}

      - name: Install dependencies and PyInstaller (PowerShell)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) {
            pip install -r requirements.txt
          } else {
            pip install pipreqs || exit 0
            pipreqs --force . || exit 0
            if (Test-Path requirements.txt) { pip install -r requirements.txt }
          }
          pip install pyinstaller

      - name: Build with PyInstaller (PowerShell)
        shell: pwsh
        env:
          INPUT_PATH: weather.py
        run: |
          pyinstaller --noconfirm --onefile --name weather $env:INPUT_PATH

          # безопасно переименовать для x86 сборки (если требуется)
          if ('${{ matrix.arch }}' -eq 'x86') {
            $src = Join-Path -Path "$PWD" -ChildPath "dist\weather.exe"
            $dst = Join-Path -Path "$PWD" -ChildPath "dist\weather-win32.exe"
            if (Test-Path $src) {
              if (Test-Path $dst) { Remove-Item -Path $dst -Force }
              Move-Item -Path $src -Destination $dst
              Write-Host "Renamed $src -> $dst"
            } else {
              Write-Host "Source executable not found: $src"
              ls dist | Write-Host
              exit 1
            }
          }

      - name: List dist for debug
        shell: pwsh
        run: |
          Write-Host "Contents of dist:"
          Get-ChildItem -Path dist -Force | ForEach-Object { Write-Host $_.FullName }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weather-windows-${{ matrix.arch }}
          path: |
            dist/*.exe

  build-linux:
    name: Build Linux binary (tar.gz)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies and PyInstaller
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pipreqs || true
            pipreqs --force . || true
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          fi
          pip install pyinstaller
        shell: bash

      - name: Build binary with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --name weather weather.py
        shell: bash

      - name: Package linux binary (tar.gz)
        run: |
          mkdir -p out
          if [ -f dist/weather ]; then
            cp dist/weather out/weather
            tar -czf out/weather-linux.tar.gz -C out weather
          else
            ls -la dist || true
            echo "dist/weather not found" >&2
            exit 1
          fi
        shell: bash

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: weather-linux-tar
          path: out/weather-linux.tar.gz
